// Cities array data created
city_data = [
    {
        'id': 1,
        'name': 'Birmingham',
        'lat': 33.53894154,
        'lng': -86.81664397
    },
    {
        'id': 2,
        'name': 'Charlotte',
        'lat': 35.23466349,
        'lng': -80.84030215
    },
    {
        'id': 3,
        'name': 'Chicagoland & Northern IL',
        'lat': 41.92561084,
        'lng': -87.61000148
    },
    {
        'id': 4,
        'name': 'Cincinnati & Dayton',
        'lat': 39.48953605,
        'lng': -84.32655339
    },
    {
        'id': 5,
        'name': 'Dallas - Fort Worth',
        'lat': 32.80091837,
        'lng': -97.02638929
    },
    {
        'id': 6,
        'name': 'Denver',
        'lat': 39.82798139,
        'lng': -104.997396
    },
    {
        'id': 7,
        'name': 'Detroit & Toledo',
        'lat': 42.00299998,
        'lng': -83.36398955
    },
    {
        'id': 9,
        'name': 'Grand Rapids',
        'lat': 42.97259808,
        'lng': -85.67133373
    },
    {
        'id': 10,
        'name': 'Greater Atlanta Area',
        'lat': 33.82387988,
        'lng': -84.42667883
    },
    {
        'id': 11,
        'name': 'Greater Boston Area',
        'lat': 42.34775132,
        'lng': -70.88933318
    },
    {
        'id': 12,
        'name': 'Cleveland & Youngstown',
        'lat': 41.2878937,
        'lng': -81.12773068
    },
    {
        'id': 13,
        'name': 'Greater Columbus Area',
        'lat': 39.96545177,
        'lng': -83.00794793
    },
    {
        'id': 14,
        'name': 'Greater Las Vegas Area',
        'lat': 36.25641193,
        'lng': -115.1604067
    },
    {
        'id': 15,
        'name': 'Greater Miami Area',
        'lat': 25.84611802,
        'lng': -80.20243214
    },
    {
        'id': 16,
        'name': 'Minneapolis - St. Paul',
        'lat': 44.98821329,
        'lng': -93.19925812
    },
    {
        'id': 17,
        'name': 'Greater Orlando Area',
        'lat': 28.63858177,
        'lng': -81.37843688
    },
    {
        'id': 18,
        'name': 'Greater Philadelphia Area',
        'lat': 40.0418458,
        'lng': -75.1568349
    },
    {
        'id': 19,
        'name': 'Greater Pittsburgh Area',
        'lat': 40.44254943,
        'lng': -79.99646373
    },
    {
        'id': 20,
        'name': 'Greater San Diego Area',
        'lat': 32.88486423,
        'lng': -117.2014131
    },
    {
        'id': 21,
        'name': 'Greater Tampa Area',
        'lat': 28.04715906,
        'lng': -82.46525417
    },
    {
        'id': 22,
        'name': 'Houston',
        'lat': 29.92299529,
        'lng': -95.28580873
    },
    {
        'id': 23,
        'name': 'Indianapolis',
        'lat': 39.82306606,
        'lng': -86.00887087
    },
    {
        'id': 25,
        'name': 'Jacksonville',
        'lat': 30.41365267,
        'lng': -81.67405732
    },
    {
        'id': 26,
        'name': 'Kansas City',
        'lat': 39.23727452,
        'lng': -94.64727307
    },
    {
        'id': 27,
        'name': 'Greater Los Angeles Area',
        'lat': 34.19145481,
        'lng': -118.3283445
    },
    {
        'id': 28,
        'name': 'Louisville & Lexington',
        'lat': 38.20794155,
        'lng': -85.0848732
    },
    {
        'id': 29,
        'name': 'Memphis & Little Rock',
        'lat': 34.94867338,
        'lng': -91.13102132
    },
    {
        'id': 30,
        'name': 'Milwaukee & WI',
        'lat': 43.91876064,
        'lng': -88.89034085
    },
    {
        'id': 31,
        'name': 'Nashville & Knoxville',
        'lat': 36.16184045,
        'lng': -85.72407445
    },
    {
        'id': 34,
        'name': 'New Orleans',
        'lat': 30.02644523,
        'lng': -90.08208773
    },
    {
        'id': 36,
        'name': 'Phoenix & Tucson',
        'lat': 33.00440348,
        'lng': -111.7056077
    },
    {
        'id': 37,
        'name': 'Portland',
        'lat': 45.68777482,
        'lng': -122.686847
    },
    {
        'id': 38,
        'name': 'Raleigh & Durham',
        'lat': 35.86001172,
        'lng': -78.64521226
    },
    {
        'id': 39,
        'name': 'Saint Louis',
        'lat': 38.78239146,
        'lng': -90.24327953
    },
    {
        'id': 40,
        'name': 'San Antonio & Austin',
        'lat': 29.85648388,
        'lng': -97.98860813
    },
    {
        'id': 42,
        'name': 'Greater Seattle Area',
        'lat': 47.79366735,
        'lng': -122.4920295
    },
    {
        'id': 47,
        'name': 'Washington DC & Maryland',
        'lat': 39.01199167,
        'lng': -76.99621831
    },
    {
        'id': 49,
        'name': 'Hawaii',
        'lat': 21.37574116,
        'lng': -157.8530221
    },
    {
        'id': 53,
        'name': 'Springfield',
        'lat': 39.84508037,
        'lng': -89.68115572
    },
    {
        'id': 55,
        'name': 'Northern New Jersey',
        'lat': 40.75862309,
        'lng': -74.57809743
    },
    {
        'id': 123,
        'name': 'Beaumont',
        'lat': 30.08645485,
        'lng': -94.12883366
    },
    {
        'id': 124,
        'name': 'Connecticut',
        'lat': 41.66039628,
        'lng': -72.54477595
    }
  ]
  
  // Create a map object.
  let myMap = L.map("map", {
      center: [37.09, -95.71],
      zoom: 5
  });
  
  // Add a tile layer.
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(myMap);
  
  // Create a layer group for city markers.
  var cityMarkerGroup = L.layerGroup().addTo(myMap);
  
  // Function to fetch events in a city using Ticketmaster API
  function getEventsInCity(id) {
    const apiKey = 'S2v9Md44UbLI7UVMA583AjbIZ4dPB5tu';

    // Define the Ticketmaster API URL to fetch events in the city
    const apiUrl = `https://app.ticketmaster.com/discovery/v2/events.json?city=${cityName}&apikey=${apiKey}&size=10`;

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            // Process the data and display event details on the map as markers
            var events = data._embedded.events;
            for (let i = 0; i < events.length; i++) {
                var event = events[i];
                var eventName = event.name;
                var eventVenue = event._embedded.venues[0].name;
                var eventDate = event.dates.start.localDate;
                var eventLat = event._embedded.venues[0].location.latitude;
                var eventLng = event._embedded.venues[0].location.longitude;

                // Create a marker for the event
                var eventMarker = L.marker([eventLat, eventLng]).addTo(myMap);

                // Add a popup with event details to the marker
                eventMarker.bindPopup(`<h1>${eventName}</h1><p>Venue: ${eventVenue}</p><p>Date: ${eventDate}</p>`);

                // Add the event marker to a separate layer group for events
                eventMarker.addTo(eventMarkerGroup);
            }
        })
        .catch(error => {
            console.error('Error fetching events:', error);
        });
}

// Create a layer group for event markers
var eventMarkerGroup = L.layerGroup();

// Loop through the cities array and create one marker for each city object.
for (let i = 0; i < city_data.length; i++) {
    var marker = L.marker([city_data[i].lat, city_data[i].lng], {
        icon: L.divIcon({ className: 'custom-div-icon' })
    }).addTo(cityMarkerGroup);

    // Add a mouseover event to show the city name when hovering over the marker.
    marker.on('mouseover', function () {
        marker.bindPopup(`<h1>${city_data[i].name}</h1>`).openPopup();
    });

    // Add a click event to fetch and display events in the city when clicking on the marker.
    marker.on('click', function () {
        // Clear previous event markers from the map
          myMap.setView([city_data[i].lat, city_data[i].lng], 9)
          eventMarkerGroup.eachLayer(function (layer) {
              if (layer !== myMap) {
                  eventMarkerGroup.removeLayer(layer);
              }
          });
        eventMarkerGroup.clearLayers();

        // Call the function to fetch and display events
          getEventsInCity(city_data[i].id);
          
          // Add back the clicked city marker to the map.
          eventMarkerGroupMarkerGroup.addLayer(marker);
    });
}